' Gambas class file

Private $hAutoSubSync As Process
Private $OutputDir As String


Public Sub Form_Open()

   Me.Center

End

Public Sub Form_Close()
   
   If $hAutoSubSync
      If $hAutoSubSync.State = Process.Running Then
         Stop Event
         Message("Please wait")
      Endif 
   Endif
   
End

Public Sub tbtVideoSync_Click()

   txtVideoSync.text = Global.GetFile()

End

Public Sub tbtSubSync_Click()

   txtSubSync.text = Global.GetFile()

End

Public Sub ToolButton3_Click()

   txtVideoDirBatch.text = Global.GetDir()
   If txtSubDirBatch.Length = 0 Then 
      txtSubDirBatch.Text = txtVideoDirBatch.Text
   Endif

End

Public Sub ToolButton4_Click()

   txtSubDirBatch.text = Global.GetDir()

End

Public Sub ToolButton5_Click()

   txtVideoDirTrain.text = Global.GetDir()
   If txtSubDirTrain.Length = 0 Then 
      txtSubDirTrain.Text = txtVideoDirTrain.Text
   Endif

End

Public Sub ToolButton6_Click()

   txtSubDirTrain.text = Global.GetDir()

End

Public Sub butSync_Click()

   If txtVideoSync.Length = 0 Or txtSubSync.Length = 0 Then
      Message.Warning("You need to select the Video and Sub files")
   Else
      'autosubsync single video:
      $OutputDir = File.Dir(txtVideoSync.text)
      DisableButtons()
      txaTerm.Clear
      $hAutoSubSync = Exec ["autosubsync", txtVideoSync.Text, txtSubSync.Text, $OutputDir & "/output.srt"] For Read As "AutoSubSync"
      Do
         Wait
      Loop While $hAutoSubSync.State = Process.Running
      Message.Info("Synced subtitle saved as " & $OutputDir & "/output.srt")
      EnableButtons()
   Endif

End

Public Sub Button2_Click()

   If txtVideoDirBatch.Length = 0 Or txtSubDirBatch.Length = 0 Then
      Message.Warning("You need to select the Videos and Subs directories")
   Endif

   'batch autosubsync:
   DisableButtons()
   txaTerm.Clear
   $hAutoSubSync = Exec ["autosubsync"] For Read As "AutoSubSync"
   Do
      Wait
   Loop While $hAutoSubSync.State = Process.Running
   EnableButtons()

End

Public Sub Button3_Click()

   If txtVideoDirTrain.Length = 0 Or txtSubDirTrain.Length = 0 Then
      Message.Warning("You need to select the Videos and Subs directories")
   Endif

   'train autosubsync:
   DisableButtons()
   txaTerm.Clear
   $hAutoSubSync = Exec ["autosubsync"] For Read As "AutoSubSync"
   Do
      Wait
   Loop While $hAutoSubSync.State = Process.Running
   EnableButtons()
   
End

Public Sub AutoSubSync_Read()
  Dim sLine As String

  Read #Last, sLine, -256
   'Print sLine
   txaTerm.Pos = txaTerm.Length
   txaTerm.Insert(sLine) '& gb.CrLf
   txaTerm.Pos = txaTerm.Length
   txaTerm.EnsureVisible()

End

Public Sub EnableButtons()
   
   butSync.enabled = True
   Button2.enabled = True
   Button3.enabled = True
   
End

Public Sub DisableButtons()
   
   butSync.enabled = False
   Button2.enabled = False
   Button3.enabled = False

End

